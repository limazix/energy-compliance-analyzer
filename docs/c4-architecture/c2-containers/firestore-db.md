
# C2 Model: Container Detail - Main Database (Firebase Firestore)

[<- Back to Container Overview (C2)](./index.md)

## Description

**Firebase Firestore** is a flexible, scalable NoSQL document-oriented database that serves as the primary data repository for the Energy Compliance Analyzer. It stores metadata, states, and the structured results of analyses.

## Responsibilities (Behaviors)

*   **Storage of Analysis Metadata:**
    *   Persists information about each analysis, including:
        *   Unique analysis ID.
        *   User ID of the analysis owner.
        *   Original CSV filename.
        *   Title and description provided by the user for the analysis.
        *   Language code for the report.
        *   Current status of the analysis process (e.g., 'uploading', 'summarizing_data', 'completed', 'error').
        *   Numerical progress of the analysis (0-100).
        *   Specific progress of the file upload (0-100).
        *   Creation and completion timestamps.
        *   Error messages, if any.
*   **Storage of File Paths:**
    *   Stores the URL or storage path (in Firebase Storage) for the original uploaded CSV file.
    *   Stores the URL or storage path for the generated MDX report.
*   **Storage of AI Processed Data:**
    *   Persists the aggregated summary of power quality data, generated by the Data Analyst Agent.
    *   Stores the list of relevant ANEEL resolutions identified by the Resolution Identifier Agent.
    *   Stores the final compliance report in structured JSON format, generated and reviewed by the AI pipeline.
*   **Tag Management:**
    *   Stores a list of tags (strings) associated with each analysis, allowing user organization and filtering.
*   **Source of Triggers for Firebase Functions:**
    *   Updates to analysis documents (especially in the `status` field) trigger the `processAnalysisOnUpdate` Firebase Function to start or continue background processing.
*   **Data Provision for Frontend:**
    *   Allows the frontend (via Server Actions) to query and display a user's list of past analyses.
    *   Allows the frontend (via Server Actions) to fetch the details of a specific analysis, including its status, progress, and structured report.

## Technologies and Constraints

*   **Core Technology:** Firebase Firestore.
*   **Database Type:** NoSQL, document-oriented. Data is organized into collections of documents, and documents contain fields (key-value pairs).
*   **Data Model:** The primary data structure is `users/{userId}/analyses/{analysisId}`.
*   **Security:** Access to data is controlled by Firestore Security Rules, which define who can read, write, or update documents based on user authentication and data structure.
*   **Queries:** Offers flexible querying capabilities, including filtering and ordering. More complex queries may require creating composite indexes.
*   **Scalability:** Firestore is designed to scale automatically to handle large amounts of data and traffic.
*   **Consistency:** Offers strong consistency for reads and writes.
*   **Costs:** Billing is based on the number of document reads, writes, deletes, and the amount of data stored and transferred over the network.
*   **Real-time Listeners:** Supports real-time listeners (`onSnapshot`) that allow client applications (or server functions) to receive data updates as they change, although in this project the primary use is for triggering Functions and occasional frontend updates via Server Actions.

    