@startuml
!define GCPPuml https://raw.githubusercontent.com/Crashedmind/PlantUML-icons-GCP/master/dist
!include GCPPuml/GCPC4Integration.puml
!include GCPPuml/IconPack.puml

!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title Next.js Server Actions Components (Backend API)

Container_Ext(frontendApp, "Frontend Web App", "Next.js Client")

package "Server Action Modules" {
    Component(fileUploadActions, "File Upload Actions", "createInitialAnalysisRecord, updateAnalysisUploadProgress, finalizeFileUploadRecord, markUploadAsFailed")
    Component(analysisMgmtActions, "Analysis Management Actions", "deleteAnalysis, cancelAnalysis")
    Component(analysisListActions, "Analysis Listing Actions", "getPastAnalyses")
    Component(tagActions, "Tag Management Actions", "addTagTo, removeTagFrom")
    Component(reportViewActions, "Report Viewing Actions", "getAnalysisReport (MDX & structured)")
    Component(reportChatActions, "Report Chat Actions", "askReportOrchestrator (invokes Genkit flow)")
    Component(analysisProcessingActions, "Analysis Processing Actions", "processAnalysisFile (signals Firebase Function via Firestore status update)")
}

ContainerDb_Ext(firestore, "Firebase Firestore", "GCP")
ContainerDb_Ext(storage, "Firebase Storage", "GCP")
ContainerDb_Ext(rtdb, "Firebase RTDB", "GCP - For Chat")
System_Ext(genkitGemini, "Genkit + Google AI (Gemini)")

Rel(frontendApp, fileUploadActions, "Calls")
Rel(frontendApp, analysisMgmtActions, "Calls")
Rel(frontendApp, analysisListActions, "Calls")
Rel(frontendApp, tagActions, "Calls")
Rel(frontendApp, reportViewActions, "Calls")
Rel(frontendApp, reportChatActions, "Calls")
Rel(frontendApp, analysisProcessingActions, "Calls")

Rel(fileUploadActions, firestore, "Writes (initial record, progress)")
Rel(analysisMgmtActions, firestore, "Updates (status), Deletes")
Rel(analysisMgmtActions, storage, "Deletes files")
Rel(analysisListActions, firestore, "Reads list")
Rel(tagActions, firestore, "Updates tags")
Rel(reportViewActions, firestore, "Reads (metadata, structuredReport)")
Rel(reportViewActions, storage, "Reads MDX file")
Rel(reportChatActions, rtdb, "Writes/Updates chat messages")
Rel(reportChatActions, firestore, "Updates structuredReport (if revised)")
Rel(reportChatActions, storage, "Writes new MDX (if revised)")
Rel(reportChatActions, genkitGemini, "Invokes orchestrateReportInteractionFlow")
Rel(analysisProcessingActions, firestore, "Updates status to trigger Function")

@enduml