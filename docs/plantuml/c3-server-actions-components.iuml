@startuml
!define GCPPuml https://raw.githubusercontent.com/Crashedmind/PlantUML-icons-GCP/master/dist
!include GCPPuml/GCPC4Integration.puml

' For specific icons, include service files e.g.:
' !include GCPPuml/Firebase/FirebaseAdminSDK.puml
' !include GCPPuml/AI/VertexAI.puml

title Next.js Server Actions Components (Container: Backend API)

package "Analysis & Upload Management" {
    Component(fileUploadActions, "File Upload Actions", "Server Actions Module", "Handles initial record creation, upload progress, finalization of CSV upload.")
    Component(analysisProcessingActions, "Analysis Processing Actions", "Server Actions Module", "Prepares and signals analysis for background processing (sets status for Firebase Function trigger).")
    Component(analysisMgmtActions, "Analysis Management Actions", "Server Actions Module", "Handles deletion and cancellation of analyses.")
    Component(tagActions, "Tag Management Actions", "Server Actions Module", "Adds/removes tags for an analysis.")
}

package "Data Retrieval & Interaction" {
    Component(analysisListActions, "Analysis Listing Actions", "Server Actions Module", "Fetches list of past analyses for a user.")
    Component(reportViewActions, "Report Viewing Actions", "Server Actions Module", "Fetches MDX report content and metadata.")
    Component(reportChatActions, "Report Chat Actions", "Server Actions Module", "Orchestrates report chat with Genkit, handles RTDB, updates Firestore/Storage on report modification.")
}

ComponentDb(firestore, "Firebase Firestore", "Firebase SDK", "Primary database interface")
ComponentDb(storage, "Firebase Storage", "Firebase SDK", "File storage interface")
ComponentDb(rtdb, "Firebase Realtime DB", "Firebase SDK", "Chat history interface")
Component(genkit_next, "Genkit (Next.js)", "Genkit SDK", "Interface for AI flows (chat orchestrator)")

' Relationships
fileUploadActions --> firestore
analysisProcessingActions --> firestore
analysisMgmtActions --> firestore
analysisMgmtActions --> storage # For deleting files
tagActions --> firestore

analysisListActions --> firestore
reportViewActions --> firestore
reportViewActions --> storage # For fetching MDX

reportChatActions --> genkit_next
reportChatActions --> rtdb
reportChatActions --> firestore # If report is modified
reportChatActions --> storage # If report MDX is re-generated

@enduml
