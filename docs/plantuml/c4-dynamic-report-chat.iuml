@startuml
!define GCPPuml https://raw.githubusercontent.com/Crashedmind/PlantUML-icons-GCP/master/dist
!include GCPPuml/GCPC4Integration.puml
!include GCPPuml/IconPack.puml

title Dynamic Diagram: Report Chat Interaction

actor User
participant "Frontend Web App\n(ReportPage)" as Frontend
participant "Server Actions\n(askReportOrchestratorAction)" as ServerAction
participant "Firebase RTDB" as RTDB
participant "Genkit Flow\n(orchestrateReportInteractionFlow)" as OrchestratorFlow
participant "Google AI (Gemini)" as Gemini
participant "Genkit Tool\n(callRevisorTool)" as RevisorTool
participant "Genkit Flow\n(reviewComplianceReportFlow)" as ReviewFlow
participant "Firebase Firestore" as Firestore
participant "Firebase Storage" as Storage

User -> Frontend: 1. Sends chat message
Frontend -> ServerAction: 2. Calls askReportOrchestratorAction (userMsg, mdx, structuredReport, etc.)
ServerAction -> RTDB: 3. Saves user message & AI placeholder
ServerAction -> OrchestratorFlow: 4. Invokes with input context

OrchestratorFlow -> Gemini: 5. Processes query (may decide to use tool)
alt User requests report modification
    OrchestratorFlow -> RevisorTool: 6. Calls callRevisorTool (with structuredReport)
    RevisorTool -> ReviewFlow: 7. Invokes reviewComplianceReportFlow
    ReviewFlow -> Gemini: 8. Uses AI to refine structured report
    Gemini --> ReviewFlow: Returns refined structured report
    ReviewFlow --> RevisorTool: 9. Returns revised report
    RevisorTool --> OrchestratorFlow: 10. Returns revised report to orchestrator
end
Gemini --> OrchestratorFlow: (If no tool, or after tool) Returns AI textual response

OrchestratorFlow --> ServerAction: 11. Returns AI response text & (optional) revisedStructuredReport

ServerAction -> RTDB: 12. Streams/Updates AI's response text
opt Report was modified
    ServerAction -> Firestore: 13. Updates structuredReport in Analysis doc
    ServerAction -> Storage: 14. Generates new MDX, saves to Storage
end

RTDB --> Frontend: 15. (via onValue) Updates chat UI with messages
opt Report was modified (Firestore listener on ReportPage)
    Firestore --> Frontend: 16. Updates report view with new MDX/structured data
end
@enduml