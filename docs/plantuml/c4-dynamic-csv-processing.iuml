@startuml c4-dynamic-csv-processing
!define GCPPuml https://raw.githubusercontent.com/Crashedmind/PlantUML-icons-GCP/master/dist
!include GCPPuml/GCPCommon.puml
' Optionally include specific services for sprites, e.g.:
' !include GCPPuml/Firebase/Firebase.puml
' !include GCPPuml/Compute/CloudFunctions.puml
' !include GCPPuml/AIML/GenerativeAI.puml

title Dynamic Diagram: CSV Analysis Processing

actor User
participant "Frontend Web App" as Frontend
participant "Server Actions" as ServerActions
participant "Firebase Firestore" as Firestore <<gcp/Firebase/Firestore>>
participant "Firebase Storage" as Storage <<gcp/Firebase/CloudStorageForFirebase>>
participant "Firebase Functions" as Functions <<gcp/Firebase/CloudFunctionsForFirebase>>
participant "Google AI (Gemini)" as Gemini <<gcp/AIML/GenerativeAI>>

autonumber

User -> Frontend: Uploads CSV & Metadata
Frontend -> ServerActions: createInitialAnalysisRecordAction()
ServerActions -> Firestore: Create Analysis (status: uploading)
Frontend -> Storage: Upload CSV file
Frontend -> ServerActions: finalizeFileUploadRecordAction()
ServerActions -> Firestore: Update Analysis (URL, status: summarizing_data)
Firestore -> Functions: Trigger onUpdate (status='summarizing_data')
Functions -> Storage: Read CSV file
Functions -> Gemini: Process data (Summarizer, Identifier, Analyzer, Reviewer Agents)
Gemini --> Functions: Structured JSON report
Functions -> Firestore: Save structured report
Functions -> Storage: Save MDX report
Functions -> Firestore: Update Analysis (status: completed, MDX path)
Frontend -> Firestore: (onSnapshot) Receives updates & displays results

@enduml
