@startuml
!define GCPPuml https://raw.githubusercontent.com/Crashedmind/PlantUML-icons-GCP/master/dist
!include GCPPuml/GCPC4Integration.puml
!include GCPPuml/IconPack.puml

!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title Firebase Functions Components (Background Processing)

ContainerDb_Ext(firestore, "Firebase Firestore", "GCP")
ContainerDb_Ext(storage, "Firebase Storage", "GCP")
System_Ext(genkitGemini, "Genkit + Google AI (Gemini)")

package "Firebase Function: processAnalysisOnUpdate" {
    Component(trigger, "Firestore Trigger", "functions.firestore.document().onUpdate", "Watches users/{uid}/analyses/{aid}")
    Component(processAnalysisFn, "Pipeline Orchestrator", "processAnalysis() in processAnalysis.js", "Main logic orchestrating AI agents and utilities")
    
    package "AI Agents (Genkit Flows)" {
        Component(dataSummarizerAgent, "Agent: Data Analyst (Summarizer)", "summarizePowerQualityDataFlow", "Reads CSV chunk, generates textual summary, suggests transformations/visualizations")
        Component(regulationIdentifierAgent, "Agent: Resolution Identifier", "identifyAEEEResolutionsFlow", "Identifies pertinent ANEEL resolutions from summary")
        Component(complianceAnalyzerAgent, "Agent: Compliance Engineer (Initial Reporter)", "analyzeReportFlow", "Generates initial structured compliance report (JSON)")
        Component(reportReviewerAgent, "Agent: Report Reviewer", "reviewReportFlow", "Refines structured report (grammar, clarity, citations)")
    }

    package "Utilities" {
        Component(gcsUtil, "Storage Access Utility", "getFileContentFromStorage()", "Reads CSV from Firebase Storage")
        Component(mdxConverterUtil, "MDX Conversion Utility", "convertStructuredReportToMdx()", "Transforms JSON report to MDX")
        Component(statusUpdaterUtil, "Status/Progress Updater", "Firestore update calls", "Updates analysis document in Firestore")
    }
}

Rel(firestore, trigger, "Triggers on update (e.g., status='summarizing_data')")
Rel(trigger, processAnalysisFn, "Invokes with event data")

Rel(processAnalysisFn, gcsUtil, "Calls to get CSV")
Rel(processAnalysisFn, dataSummarizerAgent, "Calls with CSV chunk")
Rel(processAnalysisFn, regulationIdentifierAgent, "Calls with summary")
Rel(processAnalysisFn, complianceAnalyzerAgent, "Calls with summary & resolutions")
Rel(processAnalysisFn, reportReviewerAgent, "Calls with initial report")
Rel(processAnalysisFn, mdxConverterUtil, "Calls with final JSON report")
Rel(processAnalysisFn, statusUpdaterUtil, "Calls to update Firestore")
Rel(processAnalysisFn, storage, "Writes MDX file")
Rel(processAnalysisFn, firestore, "Writes final structured report, status")


Rel(dataSummarizerAgent, genkitGemini, "Uses")
Rel(regulationIdentifierAgent, genkitGemini, "Uses")
Rel(complianceAnalyzerAgent, genkitGemini, "Uses")
Rel(reportReviewerAgent, genkitGemini, "Uses")

@enduml