@startuml
!define GCPPuml https://raw.githubusercontent.com/Crashedmind/PlantUML-icons-GCP/master/dist
!include GCPPuml/GCPC4Integration.puml

' For specific icons, include service files e.g.:
' !include GCPPuml/Firebase/FirebaseAdminSDK.puml
' !include GCPPuml/Compute/CloudFunctions.puml
' !include GCPPuml/AI/VertexAI.puml

title Firebase Functions Components (Container: Background Processing)

Component(trigger, "Firestore Trigger", "Firebase Functions SDK", "processAnalysisOnUpdate: Activated by Firestore document updates (status change).")
Component(processAnalysisFn, "Pipeline Orchestrator", "Node.js, Genkit", "Main function; coordinates AI agents and utilities for analysis.")

package "AI Agents (Genkit Flows)" {
    Component(dataSummarizerAgent, "Agent: Data Analyst (Summarizer)", "Genkit Flow (Gemini)", "Reads CSV (chunks), generates textual summary, suggests transformations.")
    Component(regulationIdentifierAgent, "Agent: Resolution Identifier", "Genkit Flow (Gemini)", "Identifies pertinent ANEEL resolutions from summary.")
    Component(complianceAnalyzerAgent, "Agent: Compliance Engineer (Initial Reporter)", "Genkit Flow (Gemini)", "Generates initial structured JSON compliance report.")
    Component(reportReviewerAgent, "Agent: Report Reviewer", "Genkit Flow (Gemini)", "Reviews and refines the structured JSON report.")
}

package "Utilities" {
    Component(gcsUtil, "Storage Access Utility", "Firebase Admin SDK (Storage)", "Reads CSV file content from Firebase Storage.")
    Component(mdxConverterUtil, "MDX Conversion Utility", "TypeScript Module (reportUtils.ts)", "Converts final JSON report to MDX format.")
    Component(statusUpdaterUtil, "Status/Progress Updater", "Firebase Admin SDK (Firestore)", "Updates analysis status and progress in Firestore.")
}

ComponentDb(firestore_admin, "Firebase Firestore (Admin)", "Firebase Admin SDK", "Interface for Firestore DB")
ComponentDb(storage_admin, "Firebase Storage (Admin)", "Firebase Admin SDK", "Interface for Storage")

' Relationships
trigger --> processAnalysisFn : Invokes

processAnalysisFn --> gcsUtil : Reads CSV
processAnalysisFn --> dataSummarizerAgent : Summarizes Data
processAnalysisFn --> regulationIdentifierAgent : Identifies Resolutions
processAnalysisFn --> complianceAnalyzerAgent : Generates Report
processAnalysisFn --> reportReviewerAgent : Reviews Report
processAnalysisFn --> mdxConverterUtil : Converts to MDX
processAnalysisFn --> storage_admin : Saves MDX
processAnalysisFn --> statusUpdaterUtil : Updates Firestore (multiple times)
processAnalysisFn --> firestore_admin : Updates Firestore (final report)

@enduml
