@startuml
!define GCPPuml https://raw.githubusercontent.com/Crashedmind/PlantUML-icons-GCP/master/dist
!include GCPPuml/GCPC4Integration.puml

' Add specific service includes if you want to use their sprites, e.g.:
' !include GCPPuml/Firebase/Firebase.puml
' !include GCPPuml/Compute/CloudFunctions.puml
' !include GCPPuml/Database/CloudFirestore.puml
' !include GCPPuml/Storage/CloudStorage.puml
' !include GCPPuml/AI/VertexAI.puml ' For Gemini

title Container Overview - Energy Compliance Analyzer

Person_Ext(user, "User", "Uploads data, views reports")

System_Boundary(eca_system, "Energy Compliance Analyzer") {
    Container(frontend_app, "Frontend Web App", "Next.js, React, ShadCN", "Provides UI for uploads, report viewing, and chat. Hosted on Firebase App Hosting.")
    Container(server_actions, "Backend API", "Next.js Server Actions", "Handles client requests, orchestrates chat AI, manages Firestore/Storage interactions. Runs on Firebase App Hosting.")
    Container(bg_processing, "Background Processing", "Firebase Functions (Node.js, Genkit)", "Executes AI pipeline for data analysis and report generation.")
    ContainerDb(main_db, "Main Database", "Firebase Firestore", "Stores analysis metadata, status, structured reports, tags.")
    ContainerDb(chat_db, "Chat Database", "Firebase Realtime DB", "Stores real-time chat history for reports.")
    ContainerDb(file_storage, "File Storage", "Firebase Storage", "Stores uploaded CSVs and generated MDX reports.")
    Container(auth_service, "Authentication Service", "Firebase Authentication", "Manages user authentication via Google Sign-In.")
}

System_Ext(google_ai, "Google AI", "Gemini Models", "Provides LLM capabilities for Genkit flows.")

Rel(user, frontend_app, "Uses")
Rel(frontend_app, server_actions, "Makes API calls via HTTPS")
Rel(server_actions, main_db, "Reads/Writes")
Rel(server_actions, file_storage, "Reads/Writes MDX (via Storage SDK)")
Rel(server_actions, chat_db, "Reads/Writes Chat History")
Rel(server_actions, google_ai, "Invokes Genkit flows for chat")
Rel(server_actions, auth_service, "Verifies User Identity")
Rel(frontend_app, auth_service, "Handles Login/Logout Flow")
Rel(frontend_app, file_storage, "Uploads CSV directly (via Storage SDK)")
Rel(frontend_app, chat_db, "Subscribes for Real-time Chat Updates")

Rel(main_db, bg_processing, "Triggers (on status update)")
Rel(bg_processing, file_storage, "Reads CSV, Writes MDX")
Rel(bg_processing, main_db, "Updates Status, Saves Structured Report")
Rel(bg_processing, google_ai, "Invokes Genkit flows for analysis pipeline")

SHOW_LEGEND()
@enduml
